name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create setup script with secrets
        run: |
          sed -i "s/NEW_USER=\"youruser\"/NEW_USER=\"${{ secrets.VPS_USER }}\"/" setup.sh
          sed -i "s/NEW_USER_PASSWORD=\"your-secure-password\"/NEW_USER_PASSWORD=\"${{ secrets.VPS_USER_PASSWORD }}\"/" setup.sh
          sed -i "s/SSH_PUBLIC_KEY=\"your-public-key-content\"/SSH_PUBLIC_KEY=\"${{ secrets.SSH_PUBLIC_KEY }}\"/" setup.sh

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          password: ${{ secrets.VPS_ROOT_PASSWORD }}
          script: |
            # Create temporary directory
            TEMP_DIR=$(mktemp -d)
            cd $TEMP_DIR

            # Copy setup script from repository
            cat > setup.sh << 'EOL'
            ${{ github.workspace }}/setup.sh
            EOL

            # Make script executable and run it
            chmod +x setup.sh
            ./setup.sh

            # Cleanup
            cd /
            rm -rf $TEMP_DIR

      - name: Post-setup instructions
          run: |
            echo "🎉 Setup completed!"
            echo "⚠️ IMPORTANT: After verifying SSH key access works, disable password authentication:"
            echo "ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'sudo sed -i \"s/PasswordAuthentication yes/PasswordAuthentication no/\" /etc/ssh/sshd_config && sudo systemctl restart sshd'"
